# Training Report: `20260221_153239_coinrun`

## Run Links

- W&B run: https://wandb.ai/mayavan-projects/world_model/runs/6zjqiq9k
- Local run dir: `runs/20260221_153239_coinrun`

## Final Metrics

| Metric | Value |
| --- | ---: |
| train.loss (step 10000) | 0.454281 |
| val.loss (step 10000) | 0.457949 |
| val.mse (step 10000) | 0.002051 |
| val.psnr (step 10000) | 26.901816 |
| val.ssim (step 10000) | 0.862937 |
| rollout.mean_mse (h=1..32, step 10000) | 0.005278 |
| rollout.mean_psnr (h=1..32, step 10000) | 23.945635 |
| rollout.mse@32 (step 10000) | 0.002322 |
| rollout.psnr@32 (step 10000) | 26.341585 |

## Model Architecture (Concise Summary)

This run uses `model.type=pixel_world_model` with `action_embed_dim=64`, `width_mult=1.0`, `n_past_frames=4`, `n_past_actions=3`, and `n_future_frames=4`.

The network is an action-conditioned encoder-decoder with FiLM conditioning:

- Action tokens (`past_actions + future_actions`) are embedded with `nn.Embedding` and flattened into a single conditioning vector.
- The encoder consumes the stacked past frames plus 2 coordinate channels (`x,y` grid), then applies 4 conv blocks.
- Each encoder block applies FiLM modulation (`(1+gamma)*h + beta`) and GroupNorm + ReLU.
- The decoder upsamples back to `84x84` over 4 stages (nearest-neighbor upsampling + conv blocks), again with FiLM + GroupNorm + ReLU.
- Output is logits with `out_channels=n_future_frames=4`, predicting 4 future frames at once.

## Supervision Signal

Training is teacher-forced one-step supervised prediction over future frame targets:

- Inputs: `obs` (past frame stack), `past_actions`, and `future_actions`.
- Targets: `next_obs` with shape `(B, n_future_frames, 84, 84)`.
- Core loss: pixel-wise `binary_cross_entropy_with_logits(logits, next_obs, reduction="none")`.
- Motion-aware weighting: a mask is built from `abs(next_obs - last_input_frame) > motion_tau`, dilated with max-pooling (`motion_dilate_px`), then converted to weights:
  - `weights = 1 + motion_weight * motion_mask`
  - weights are normalized by their mean before loss reduction.
- Final scalar loss: mean of `weights * BCE_map`.

Validation computes the same weighted loss and additionally logs image-quality metrics (`MSE`, `PSNR`, `SSIM`). Rollout validation logs horizon-wise `MSE/PSNR` curves up to horizon 32.
